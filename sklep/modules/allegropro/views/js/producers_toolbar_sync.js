(function(){
  if (typeof window.jQuery === 'undefined') return; var $=window.jQuery;
  if (!(/[?&]controller=AdminXAllegroAssoc(?:Manufacturers)?/i.test(location.search))) return;
  function getToken(){ if (typeof token!=='undefined'&&token) return token; if (typeof static_token!=='undefined'&&static_token) return static_token; var m=location.search.match(/[?&]token=([^&]+)/i); return m?decodeURIComponent(m[1]):''; }
  function api(p){ p=p||{}; p.ajax=1; p.token=getToken(); return $.getJSON('index.php',$.extend({controller:'AdminXAllegroAssocManufacturers'},p)); }
  function place($p){ var $s=$('h3:contains(\"Powiązania producentów\")').first(); if($s.length){$s.append($p);return true;} var $ph=$('.page-head .page-title, .panel-heading').first(); if($ph.length){$ph.append($p);return true;} return false; }
  function inject(){ if($('#x13-build-producers-panel').length) return; var $p=$('<span id=\"x13-build-producers-panel\" style=\"margin-left:10px;display:inline-block;\"></span>'); var $sel=$('<select id=\"x13-acc\" class=\"form-control\" style=\"display:inline-block;width:auto;margin-right:8px;display:none;\"></select>'); var $chk=$('<label class=\"checkbox\" style=\"display:inline-block;margin-right:8px;\"><input type=\"checkbox\" id=\"x13-dry\"> Tryb testowy (bez zapisu)</label>'); var $btn=$('<a class=\"btn btn-primary\" id=\"x13-run\"><i class=\"icon-refresh\"></i> Zbuduj bazę producentów (Allegro)</a>'); $p.append($sel).append($chk).append($btn); if(!place($p)) return; function ensureAcc(done){ if($sel.data('loaded')){done();return;} api({action:'ListAccounts'}).done(function(r){ if(!r||!r.success||!r.accounts||!r.accounts.length){alert('Brak kont Allegro / token wygasł. Otwórz główną stronę X13 i wróć.');return;} if(r.accounts.length>1){$sel.show();} r.accounts.forEach(function(a){$('<option/>',{value:a.account_key,text:a.label+(a.is_sandbox?' (SANDBOX)':' (PROD)')}).appendTo($sel);}); $sel.data('loaded',true); done(); }); } $btn.on('click', function(){ var $b=$(this).prop('disabled',true); ensureAcc(function(){ var k=$sel.val()||null; api({action:'SyncMissingProducers', account_key:k, dry:$('#x13-dry').is(':checked')?1:0}).done(function(resp){ var msg=''; if(!resp||!resp.success){ msg='Błąd: '+(resp&&resp.error?resp.error:'unknown'); } else { (resp.rows||[]).slice(0,12).forEach(function(x){ msg+='['+(x.action||'?')+'] '+(x.m||'')+(x.id?(' → '+x.id):'')+(x.msg?(' ('+x.msg+')'):'')+'\n'; }); if((resp.rows||[]).length>12) msg+='… ('+resp.rows.length+' pozycji)\n'; } alert(msg||'OK'); try{location.reload();}catch(e){} }).always(function(){ $b.prop('disabled',false); }); }); }); }
  $(function(){ inject(); });
})();